// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================
// ‚úÖ –¢–∏–ø—ã –æ—Ç—á—ë—Ç–æ–≤
// ===========================

enum ReportType {
  PALM
  NUM
  ASTRO
  SYNTH
}

enum ReportStatus {
  DRAFT
  READY
  FAILED
}

enum PalmSide {
  LEFT
  RIGHT
}

enum PalmScanStatus {
  DRAFT
  ANALYZING
  READY
  BAD_PHOTO
  FAILED
}

enum ShareStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  telegramId String @unique
  username   String?
  firstName  String?
  lastName   String?

  // –î–ª—è –±—É–¥—É—â–µ–≥–æ: —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ / A-B —Ç–µ—Å—Ç—ã / –º–µ—Ç–∫–∏
  locale String? @default("ru")
  meta   Json?   @db.Json

  profile   Profile?
  palmScans PalmScan[]
  reports   Report[]
  shares    ReportShare[]

  @@index([createdAt])
  @@index([telegramId])
}

model Profile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // üî¢ –ö–æ–¥ –¥–∞—Ç—ã / ‚≠ê –ö–∞—Ä—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
  // dob –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–∞–ª—å–Ω–æ –¥–µ–ª–∞–µ—Ç NUM/ASTRO,
  // –Ω–æ –≤ –ë–î –ø—É—Å—Ç—å –±—É–¥–µ—Ç nullable ‚Äî –Ω–µ –∑–∞—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç–∞—Ä—Ç–µ.
  dob       DateTime?
  birthTime String?  // "HH:MM" (–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è) –∏–ª–∏ null, –µ—Å–ª–∏ "–Ω–µ –∑–Ω–∞—é"
  birthCity String?  // —Å—Ç—Ä–æ–∫–∞, –±–µ–∑ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ –≤ v1
  // –Ω–∞ –±—É–¥—É—â–µ–µ: —Å—Ç—Ä–∞–Ω–∞/–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å —Ç–æ—á–Ω–æ—Å—Ç—å
  birthMeta Json? @db.Json

  // –ò–º—è –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ Telegram, –ø–æ—ç—Ç–æ–º—É –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  displayName String?

  @@index([userId])
  @@index([dob])
}

model PalmScan {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 2 —Ñ–æ—Ç–æ –ª–∞–¥–æ–Ω–µ–π
  leftImageUrl  String?
  rightImageUrl String?

  // –¢–µ—Ö. –º–µ—Ç–∞ —Ñ–∞–π–ª–æ–≤/–∑–∞–≥—Ä—É–∑–∫–∏, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –Ω–µ –≥–∞–¥–∞—Ç—å
  leftMeta  Json? @db.Json
  rightMeta Json? @db.Json

  status PalmScanStatus @default(DRAFT)

  // –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –ª–∞–¥–æ–Ω–∏ (JSON —Å—Ç—Ä–æ–≥–æ –ø–æ —Å—Ö–µ–º–µ) + —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–µ–∫—Ü–∏–∏
  aiJson Json? @db.Json
  aiText String?

  // –ö–∞—á–µ—Å—Ç–≤–æ/–¥–æ–≤–µ—Ä–∏–µ
  confidence  Float?
  qualityFlag Boolean @default(false) // true = –ø–ª–æ—Ö–æ–µ —Ñ–æ—Ç–æ/–Ω–∏–∑–∫–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å
  qualityNote String?

  // –û—à–∏–±–∫–∞, –µ—Å–ª–∏ —É–ø–∞–ª–∏ –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ
  errorCode String?
  errorText String?

  // –£–¥–æ–±–Ω–æ: –æ–¥–∏–Ω PalmScan –æ–±—ã—á–Ω–æ –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –æ–¥–∏–Ω Report(PALM),
  // –Ω–æ –º—ã –Ω–µ –¥–µ–ª–∞–µ–º –∂–µ—Å—Ç–∫–æ 1:1, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–µ—Ä–µ—Å–∫–∞–Ω–∏—Ç—å –∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é.
  reports Report[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([userId, status, createdAt])
}

model Report {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type   ReportType
  status ReportStatus @default(DRAFT)

  // –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: json ‚Äî –º–∞—à–∏–Ω–Ω—ã–π, text ‚Äî –∫—Ä–∞—Å–∏–≤—ã–π –¥–ª—è UI/—ç–∫—Å–ø–æ—Ä—Ç–∞
  json Json? @db.Json
  text String?

  // –°–≤—è–∑–∏ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
  palmScanId String?
  palmScan   PalmScan? @relation(fields: [palmScanId], references: [id], onDelete: SetNull)

  // –î–ª—è NUM/ASTRO/SYNTH —É–¥–æ–±–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ/—Ä–∞—Å—á—ë—Ç—ã
  input Json? @db.Json

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–æ–º/–¥–æ–≤–µ—Ä–∏–µ
  confidence Float?

  // –û—à–∏–±–∫–∏
  errorCode String?
  errorText String?

  // –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –ø–æ —Å—Å—ã–ª–∫–µ/—ç–∫—Å–ø–æ—Ä—Ç
  shares ReportShare[]

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([userId, type, createdAt])
  @@index([palmScanId])
}

model ReportShare {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  reportId String
  report   Report  @relation(fields: [reportId], references: [id], onDelete: Cascade)

  status ShareStatus @default(ACTIVE)

  // –¢–æ–∫–µ–Ω –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–π —Å—Å—ã–ª–∫–∏/–≤—ã–≥—Ä—É–∑–∫–∏ (–Ω–µ —É–≥–∞–¥—ã–≤–∞–µ–º—ã–π)
  token     String   @unique
  expiresAt DateTime?
  revokedAt DateTime?

  // –ø–æ –∂–µ–ª–∞–Ω–∏—é: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Äú–æ–¥–∏–Ω —Ä–∞–∑‚Äù
  maxViews Int?
  views    Int @default(0)

  meta Json? @db.Json

  @@index([userId])
  @@index([reportId])
  @@index([status])
  @@index([expiresAt])
  @@index([token])
}
